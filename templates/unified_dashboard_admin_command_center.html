<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Command Center - CrimeGuard Pro</title>
  <meta name="description" content="Admin Command Center - manage users, cases, officers, FIRs, alerts and system settings." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#f8fafc', 100: '#f1f5f9', 800: '#1e293b', 900: '#0f172a' },
            accent: { 500: '#e67e22', 600: '#c2410c' },
            success: { 50: '#f0fdf4', 500: '#22c55e' },
            error: { 50: '#fef2f2', 500: '#ef4444' },
            warning: { 50: '#fffbeb', 500: '#f59e0b' }
          }
        }
      }
    };
  </script>

  <style>
    /* THEME & BASE */
    :root{
      --primary: #2c3e50; --accent: #e67e22; --success: #22c55e; --warning: #f39c12; --error: #e74c3c;
      --bg: #ffffff; --surface: #f8f9fa; --muted: #7f8c8d; --border: #e5e7eb;
      --card-shadow: 0 2px 8px rgba(44,62,80,0.08); --modal-shadow: 0 10px 30px rgba(12,18,24,0.12);
      --max-w: 1300px; font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    html,body{height:100%;margin:0;background:var(--surface);color:var(--primary);-webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none}
    .container{max-width:var(--max-w);margin:0 auto;padding:18px}

    /* LAYOUT */
    .flex{display:flex}.items-center{align-items:center}.justify-between{justify-content:space-between}
    .gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}
    .grid{display:grid;gap:12px}.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr 1fr}

    /* UI */
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem .9rem;border-radius:.5rem;border:1px solid var(--border);cursor:pointer;background:var(--bg)}
    .btn-primary{background:var(--primary);color:#fff;border:none}.btn-accent{background:var(--accent);color:#fff;border:none}
    .btn-secondary{background:#394b57;color:#fff;border:none}.btn-sm{padding:.35rem .6rem;font-size:.9rem}
    .danger{background:transparent;color:var(--error);border:1px solid rgba(231,76,60,0.22);padding:.45rem .7rem;border-radius:.45rem;cursor:pointer}

    .card{background:var(--bg);border-radius:.6rem;padding:16px;border:1px solid var(--border);box-shadow:var(--card-shadow)}
    header{background:var(--bg);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:60}
    .logo{height:44px}
    h1,h2,h3{margin:0}.muted{color:var(--muted)}.small{font-size:.9rem}.xs{font-size:.8rem}
    .badge{display:inline-block;padding:.18rem .5rem;border-radius:999px;font-size:.8rem}.badge-high{background:var(--error);color:#fff}
    .badge-med{background:var(--warning);color:#fff}.badge-normal{background:var(--primary);color:#fff}

    .table{width:100%;border-collapse:collapse}.table th,.table td{padding:.6rem;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle}
    .table-scroll{max-height:420px;overflow:auto}
    .input{width:100%;padding:.6rem .75rem;border:1px solid var(--border);border-radius:.45rem;background:#fff}
    
    /* Action Buttons Container */
    .actions{
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: nowrap;
      justify-content: flex-start;
      width: 100%;
    }
    @media (max-width: 768px) {
      .actions{
        flex-wrap: wrap;
      }
    }
    .actions .btn{
      white-space: nowrap;
      min-width: auto;
      flex-shrink: 0;
      margin: 0;
      font-size: 0.875rem;
      padding: 0.4rem 0.75rem;
      transition: all 0.2s ease;
    }
    .actions .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .actions .btn.btn-primary{
      background: var(--primary);
      color: #fff;
      border: none;
    }
    .actions .btn.btn-primary:hover{
      background: #1a2530;
    }
    .actions .btn.danger{
      background: transparent;
      color: var(--error);
      border: 1px solid rgba(231,76,60,0.3);
    }
    .actions .btn.danger:hover{
      background: rgba(231,76,60,0.1);
      border-color: var(--error);
    }
    .actions .btn:not(.btn-primary):not(.danger){
      background: #fff;
      color: var(--primary);
      border: 1px solid var(--border);
    }
    .actions .btn:not(.btn-primary):not(.danger):hover{
      background: #f8f9fa;
      border-color: var(--primary);
    }

    /* Modal Styles */
    .modal-backdrop{ 
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      padding: 20px;
      overflow-y: auto;
    }
    .modal-backdrop.open{ 
      display: flex;
      opacity: 1;
      pointer-events: auto;
    }
    .modal{ 
      background: white;
      border-radius: 1rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      width: 100%;
      max-width: 48rem;
      padding: 1.5rem;
      margin: auto;
      transform: scale(0.95);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    .modal-backdrop.open .modal{ 
      transform: scale(1);
      opacity: 1;
    }
    .modal .modal-header{ 
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e5e7eb;
    }

    /* Prevent body scroll when modal is open */
    body.modal-open {
      overflow: hidden;
    }

    /* Small screens tweaks */
    @media (max-width: 640px) {
      .modal { 
        margin: 0.5rem;
        padding: 1rem;
        max-width: calc(100% - 1rem);
      }
      .modal-backdrop {
        padding: 10px;
      }
    }

    @media (max-width:980px){.grid-3{grid-template-columns:1fr}.grid-2{grid-template-columns:1fr}.container{padding:12px}}
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="container flex items-center justify-between" style="height:72px">
      <div class="flex items-center gap-3">
        <img src="/static/images/newlogo.png" alt="CrimeGuard Pro" class="logo">
        <div>
          <div style="font-weight:700;font-size:1.05rem">CrimeGuard Pro</div>
          <div class="xs muted">Admin Command Center</div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div class="search card" style="padding:6px 10px;border-radius:999px;display:flex;align-items:center;gap:6px">
          üîç
          <input id="globalSearch" placeholder="Search users, cases or IDs..." class="input" style="border:none;box-shadow:none;width:320px;padding:.4rem .6rem"/>
        </div>

        <button class="btn" id="openNotificationsBtn" title="Notifications">
          üîî <span class="badge badge-high" id="notifCount">0</span>
        </button>

        <div style="position:relative">
          <button class="btn" id="openUserMenuBtn">
            <img id="adminAvatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="Admin" style="height:30px;border-radius:999px">
            <span id="adminShortName" style="margin-left:.5rem">Admin</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- USER DROPDOWN -->
  <div id="userDropdown" style="position:absolute;right:18px;top:76px;display:none;z-index:70">
    <div class="card" style="width:260px">
      <div style="padding-bottom:6px;border-bottom:1px solid var(--border);margin-bottom:8px">
        <div id="adminFullName" style="font-weight:700">Admin</div>
        <div id="adminRoleBadge" class="small-muted">Role: admin</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <a href="/admin-dashboard.html" class="small-muted">Admin Dashboard</a>
        <a href="/logout" class="small-muted">Sign out</a>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <main class="container" style="padding-top:18px;padding-bottom:40px">

    <!-- TOP CONTROLS -->
    <section class="card mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
      <div>
        <h1 class="text-2xl font-bold text-primary-800 mb-1">Admin Command Center</h1>
        <div class="text-sm text-primary-600">Manage users, cases, officers, FIRs and alerts</div>
      </div>

      <div class="flex flex-wrap gap-2">
        <button class="px-4 py-2 bg-accent-500 text-white rounded-lg font-semibold hover:bg-accent-600 transition shadow-md flex items-center gap-2" id="btnAddUser">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Add User
        </button>
        <button class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition flex items-center gap-2" id="btnReload">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          Refresh
        </button>
        <button class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition flex items-center gap-2" id="btnOpenAllCases">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          View Cases
        </button>
      </div>
    </section>

    <!-- STATS -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
      <div class="card hover:shadow-lg transition-shadow">
        <div class="text-sm text-primary-600 font-medium mb-1">Total Users</div>
        <div id="statTotalUsers" class="text-3xl font-bold text-primary-800 mb-1">‚Äî</div>
        <div class="text-xs text-primary-500">All registered accounts</div>
      </div>

      <div class="card hover:shadow-lg transition-shadow">
        <div class="text-sm text-primary-600 font-medium mb-1">Active (Last 7d)</div>
        <div id="statActiveUsers" class="text-3xl font-bold text-success-500 mb-1">‚Äî</div>
        <div class="text-xs text-primary-500">Recent login activity</div>
      </div>

      <div class="card hover:shadow-lg transition-shadow">
        <div class="text-sm text-primary-600 font-medium mb-1">Officers</div>
        <div id="statOfficers" class="text-3xl font-bold text-primary-800 mb-1">‚Äî</div>
        <div class="text-xs text-primary-500">Officer accounts</div>
      </div>

      <div class="card hover:shadow-lg transition-shadow">
        <div class="text-sm text-primary-600 font-medium mb-1">Citizens</div>
        <div id="statCitizens" class="text-3xl font-bold text-accent-500 mb-1">‚Äî</div>
        <div class="text-xs text-primary-500">Citizen accounts</div>
      </div>
    </section>

    <!-- LAYOUT: USERS + RIGHT PANEL -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">

      <!-- LEFT: USERS TABLE -->
      <div class="lg:col-span-2">
        <div class="card mb-3 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
          <div>
            <h2 class="text-lg font-bold text-primary-800 mb-1">All Users</h2>
            <div class="text-sm text-primary-600">Manage user accounts and roles</div>
          </div>
          <div class="flex flex-wrap gap-2 items-center">
            <select id="filterRole" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition outline-none bg-white text-sm">
              <option value="">All roles</option>
              <option value="admin">Admin</option>
              <option value="officer">Officer</option>
              <option value="citizen">Citizen</option>
            </select>
            <input id="filterQuery" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition outline-none text-sm" placeholder="Search name or email" style="width:220px"/>
            <button class="px-4 py-2 bg-primary-800 text-white rounded-lg font-semibold hover:bg-primary-900 transition text-sm" id="applyFilters">Apply</button>
          </div>
        </div>

        <div class="card table-scroll">
          <table class="table" id="usersTable">
            <thead>
              <tr>
                <th style="width:6%">#</th>
                <th style="width:26%">Name</th>
                <th style="width:20%">Email</th>
                <th style="width:10%">Role</th>
                <th style="width:10%">Badge / Dept</th>
                <th style="width:12%">Last Login</th>
                <th style="width:18%;min-width:200px">Actions</th>
              </tr>
            </thead>
            <tbody id="usersTbody">
              <tr><td colspan="7" class="small-muted">Loading users...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT: ACTIVITY & QUICK ACTIONS -->
      <aside class="space-y-3">
        <div class="card">
          <h3 class="text-base font-bold text-primary-800 mb-3 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-accent-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Recent Admin Activity
          </h3>
          <div id="adminActivityList" class="flex flex-col gap-2">
            <div class="text-sm text-primary-500">No activity yet</div>
          </div>
        </div>

        <div class="card">
          <h3 class="text-base font-bold text-primary-800 mb-3 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-accent-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            Quick User Actions
          </h3>
          <div class="flex flex-col gap-2">
            <button class="px-4 py-2 bg-primary-800 text-white rounded-lg font-semibold hover:bg-primary-900 transition text-sm flex items-center justify-center gap-2" id="bulkExportBtn">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              Export CSV
            </button>
            <button class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition text-sm" id="bulkDeactivateBtn">Deactivate Selected</button>
          </div>
        </div>

        <div class="card">
          <h3 class="text-base font-bold text-primary-800 mb-3 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-accent-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            System Info
          </h3>
          <div class="text-sm text-primary-600 space-y-1">
            <div>API Base: <span id="apiBase" class="font-mono text-primary-800">/api</span></div>
            <div>Server: <span id="serverUrl" class="font-mono text-primary-800">http://127.0.0.1:3000</span></div>
          </div>
        </div>
      </aside>
    </section>

    <!-- CASES PANEL -->
    <section class="mt-5">
      <div class="card mb-3 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
          <h2 class="text-lg font-bold text-primary-800 mb-1">Cases</h2>
          <div class="text-sm text-primary-600">View and manage all cases</div>
        </div>
        <div class="flex gap-2">
          <button class="px-4 py-2 bg-accent-500 text-white rounded-lg font-semibold hover:bg-accent-600 transition shadow-md flex items-center gap-2" id="btnAddCase">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Add Case
          </button>
          <button class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition flex items-center gap-2" id="btnReloadCases">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Refresh
          </button>
        </div>
      </div>

      <div class="card table-scroll">
        <table class="table" id="casesTable">
          <thead>
            <tr>
              <th style="width:6%">#</th>
              <th style="width:28%">Title</th>
              <th style="width:12%">Type</th>
              <th style="width:14%">Status</th>
              <th style="width:16%">Assigned</th>
              <th style="width:12%">Created</th>
              <th style="width:18%;min-width:200px">Actions</th>
            </tr>
          </thead>
          <tbody id="casesTbody">
            <tr><td colspan="7" class="small-muted">Loading cases...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- FIRs & Alerts -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-5">
      <div class="card">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 mb-3">
          <div>
            <h3 class="text-base font-bold text-primary-800 mb-1 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-accent-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              Officer FIRs
            </h3>
            <div class="text-sm text-primary-600">View and manage all FIR records</div>
          </div>
          <button class="px-3 py-1.5 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition text-sm flex items-center gap-1" id="btnReloadFirs" title="Refresh FIRs">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Refresh
          </button>
        </div>
        <div class="table-scroll">
          <table class="table" id="firsTable">
            <thead><tr><th>#</th><th>Title</th><th>Officer</th><th>Status</th><th>Created</th><th style="width:18%;min-width:200px">Actions</th></tr></thead>
            <tbody id="firsTbody"><tr><td colspan="6" class="small-muted">Loading FIRs...</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 mb-3">
          <div>
            <h3 class="text-base font-bold text-primary-800 mb-1 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-accent-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
              </svg>
              Alerts
            </h3>
            <div class="text-sm text-primary-600">Active system alerts</div>
          </div>
          <button class="px-3 py-1.5 bg-accent-500 text-white rounded-lg font-semibold hover:bg-accent-600 transition text-sm flex items-center gap-1" id="btnSendAlert">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Send Alert
          </button>
        </div>
        <div id="alertsList" class="space-y-2"> <div class="text-sm text-primary-500">Loading alerts...</div> </div>
      </div>
    </section>

  </main>

  <!-- Footer -->
  <footer class="bg-primary-900 text-white py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
            <!-- Company Info -->
            <div class="col-span-1 md:col-span-2">
                <div class="flex items-center mb-4">
                    <svg class="h-8 w-8 text-white mr-3" viewBox="0 0 40 40" fill="currentColor">
                    </svg>
                    <div>
                      <img src="/static/images/newlogo1.png" style="height: 100px; width: 250;">
                    </div>
                </div>
                <p class="text-primary-200 mb-4">Secure authentication gateway ensuring safe access to CrimeGuard Pro's comprehensive crime management ecosystem.</p>
                <div class="flex space-x-4">
                  
                    <a href="javascript:void(0)" class="text-primary-300 hover:text-white transition-smooth">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.2-1.95-.5v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"/>
                        </svg>
                    </a>
                    <a href="javascript:void(0)" class="text-primary-300 hover:text-white transition-smooth">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                    </a>
                </div>
            </div>

            <!-- Quick Links -->
            <div>
                <h4 class="text-lg font-inter font-semibold mb-4">Quick Links</h4>
                <ul class="space-y-2">
                    <li><a href="homepage_government_technology_platform.html" class="text-primary-200 hover:text-white transition-smooth">Home</a></li>
                    <li><a href="/login" class="text-primary-200 hover:text-white transition-smooth">Login</a></li>
                    <li><a href="document_center_secure_file_management.html" class="text-primary-200 hover:text-white transition-smooth">Documents</a></li>
                    <li><a href="/analytics" class="text-primary-200 hover:text-white transition-smooth">Reports</a></li>
                </ul>
            </div>

            <!-- Support -->
            <div>
              <h4 class="text-lg font-inter font-semibold mb-4">Support</h4>
              <ul class="space-y-2">
                  <li><a href="/help_center" class="small-muted">Help Center</a>
                  </li>
                  <li><a href="/contact" class="text-primary-200 hover:text-white transition-smooth">Contact Us</a></li>
                  <li><a href="/privacy_policy" class="text-primary-200 hover:text-white transition-smooth">Privacy Policy</a></li>
                  <li><a href="/terms_of_service" class="text-primary-200 hover:text-white transition-smooth">Terms of Service</a></li>
                  <li><a href="/accessibility" class="text-primary-200 hover:text-white transition-smooth">Accessibility</a></li>
              </ul>
          </div>
      </div>

        <div class="border-t border-primary-700 mt-8 pt-8 text-center">
            <p class="text-primary-200">&copy; 2025 CrimeGuard Pro. All Rights Reserved. | Secure authentication for justice and transparency.</p>
        </div>
    </div>
</footer>

  <!-- MODALS -->
  <!-- User Modal -->
  <div id="userModal" class="modal-backdrop" aria-hidden="true" style="display: none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="userModalTitle">
      <div class="modal-header">
        <h3 id="userModalTitle" class="text-xl font-bold text-primary-800 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-accent-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
          Add User
        </h3>
        <button class="p-1.5 text-primary-600 hover:text-primary-900 hover:bg-gray-100 rounded-lg transition" id="closeUserModal">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <form id="userForm" class="space-y-5">
        <input type="hidden" id="userId" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label class="block text-sm font-semibold text-primary-700 mb-2">First Name <span class="text-red-500">*</span></label>
            <input id="firstName" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition outline-none" placeholder="First name" required />
          </div>
          <div>
            <label class="block text-sm font-semibold text-primary-700 mb-2">Last Name</label>
            <input id="lastName" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition outline-none" placeholder="Last name" />
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label class="block text-sm font-semibold text-primary-700 mb-2">Email <span class="text-red-500">*</span></label>
            <input id="email" type="email" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition outline-none" placeholder="user@example.com" required />
          </div>
          <div>
            <label class="block text-sm font-semibold text-primary-700 mb-2">Role <span class="text-red-500">*</span></label>
            <select id="role" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition outline-none bg-white">
              <option value="citizen">Citizen</option>
              <option value="officer">Officer</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label class="block text-sm font-semibold text-primary-700 mb-2">Badge / ID</label>
            <input id="badge" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition outline-none" placeholder="Badge # or identifier (officers only)" />
          </div>
          <div>
            <label class="block text-sm font-semibold text-primary-700 mb-2">Department</label>
            <input id="department" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition outline-none" placeholder="Department (Officer only)" />
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-primary-700 mb-2">Temporary Password</label>
          <input id="password" type="password" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition outline-none" placeholder="Set temporary password (required for new users)" />
        </div>

        <div class="flex justify-between items-center pt-4 border-t border-gray-200">
          <div id="userFormResult" class="text-sm font-medium"></div>
          <div class="flex gap-3">
            <button type="button" class="px-5 py-2.5 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition" id="cancelUserBtn">Cancel</button>
            <button type="submit" class="px-5 py-2.5 bg-accent-500 text-white rounded-lg font-semibold hover:bg-accent-600 transition shadow-md" id="saveUserBtn">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Case Modal -->
  <div id="caseModal" class="modal-backdrop" aria-hidden="true" style="display: none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="caseModalTitle">
      <div class="modal-header">
        <h3 id="caseModalTitle" class="text-xl font-bold text-primary-800 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-accent-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          Add Case
        </h3>
        <button class="p-1.5 text-primary-600 hover:text-primary-900 hover:bg-gray-100 rounded-lg transition" id="closeCaseModal">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <form id="caseForm" class="space-y-5">
        <input type="hidden" id="caseId" />
        <div>
          <label class="block text-sm font-semibold text-primary-700 mb-2">Title <span class="text-red-500">*</span></label>
          <input id="caseTitle" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition outline-none" required />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label class="block text-sm font-semibold text-primary-700 mb-2">Type / Category</label>
            <input id="caseType" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition outline-none" placeholder="e.g., Theft, Assault" />
          </div>
          <div>
            <label class="block text-sm font-semibold text-primary-700 mb-2">Status</label>
            <select id="caseStatus" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition outline-none bg-white">
              <option value="Pending">Pending</option>
              <option value="In Progress">In Progress</option>
              <option value="Resolved">Resolved</option>
              <option value="Closed">Closed</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-semibold text-primary-700 mb-2">Assigned Officer ID</label>
          <input id="caseAssigned" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition outline-none" placeholder="Officer ID or badge number" />
        </div>
        <div>
          <label class="block text-sm font-semibold text-primary-700 mb-2">Description</label>
          <textarea id="caseDescription" rows="5" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition outline-none resize-none" placeholder="Case description and details..."></textarea>
        </div>

        <div class="flex justify-between items-center pt-4 border-t border-gray-200">
          <div id="caseFormResult" class="text-sm font-medium"></div>
          <div class="flex gap-3">
            <button type="button" class="px-5 py-2.5 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition" id="cancelCaseBtn">Cancel</button>
            <button type="submit" class="px-5 py-2.5 bg-accent-500 text-white rounded-lg font-semibold hover:bg-accent-600 transition shadow-md" id="saveCaseBtn">Save Case</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- FIR Modal -->
  <div id="firModal" class="modal-backdrop" aria-hidden="true" style="display: none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="firModalTitle">
      <div class="modal-header">
        <h3 id="firModalTitle" class="text-xl font-bold text-primary-800 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-accent-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          View/Edit FIR
        </h3>
        <button class="p-1.5 text-primary-600 hover:text-primary-900 hover:bg-gray-100 rounded-lg transition" id="closeFirModal">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <form id="firForm" class="space-y-5">
        <input type="hidden" id="firId" />
        <div>
          <label class="block text-sm font-semibold text-primary-700 mb-2">Title</label>
          <input id="firTitle" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed" readonly />
        </div>
        <div>
          <label class="block text-sm font-semibold text-primary-700 mb-2">Officer</label>
          <input id="firOfficer" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed" readonly />
        </div>
        <div>
          <label class="block text-sm font-semibold text-primary-700 mb-2">Status</label>
          <select id="firStatus" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition outline-none bg-white">
            <option value="Pending">Pending</option>
            <option value="In Progress">In Progress</option>
            <option value="Resolved">Resolved</option>
            <option value="Closed">Closed</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-primary-700 mb-2">Admin Notes</label>
          <textarea id="firDetails" rows="5" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition outline-none resize-none" placeholder="Add admin notes or updates..."></textarea>
        </div>
        <div class="flex justify-between items-center pt-4 border-t border-gray-200">
          <div id="firFormResult" class="text-sm font-medium"></div>
          <div class="flex gap-3">
            <button type="button" class="px-5 py-2.5 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition" id="cancelFirBtn">Cancel</button>
            <button type="submit" class="px-5 py-2.5 bg-accent-500 text-white rounded-lg font-semibold hover:bg-accent-600 transition shadow-md" id="saveFirBtn">Update FIR</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirm Delete Modal (generic) -->
  <div id="confirmDeleteModal" class="modal-backdrop" aria-hidden="true" style="display: none;">
    <div class="modal" style="max-width: 28rem;" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="flex items-center gap-3">
          <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
          </div>
          <div>
            <h3 class="text-xl font-bold text-primary-800">Confirm Delete</h3>
            <p class="text-sm text-primary-600 mt-1">This action cannot be undone</p>
          </div>
        </div>
        <button class="p-1.5 text-primary-600 hover:text-primary-900 hover:bg-gray-100 rounded-lg transition" id="closeConfirmDelete">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="pt-4">
        <p id="confirmDeleteMessage" class="text-sm text-primary-700 mb-6 leading-relaxed">Are you sure you want to delete? All associated data will be permanently removed.</p>
        <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
          <button class="px-5 py-2.5 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition" id="cancelDeleteBtn">Cancel</button>
          <button class="px-5 py-2.5 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition shadow-md" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <script>
/* Updated dashboard script ‚Äî handles the case and FIR shapes you provided,
   robust ID & date parsing, and fallback mappings for user fields. */

const API_BASE = '/api';
const SERVER_URL = 'http://127.0.0.1:3000';
const $ = id => document.getElementById(id);

if ($('apiBase')) $('apiBase').textContent = API_BASE;
if ($('serverUrl')) $('serverUrl').textContent = SERVER_URL;

function showModal(el){ 
  if(!el) return; 
  document.body.classList.add('modal-open');
  el.style.display='flex'; 
  setTimeout(()=>el.classList.add('open'),10); 
}
function hideModal(el){ 
  if(!el) return; 
  document.body.classList.remove('modal-open');
  el.classList.remove('open'); 
  setTimeout(()=>{ el.style.display='none'; }, 300);
}
function getToken(){ 
  // Check multiple possible token keys (login page uses 'authToken')
  const tokenKeys = ['authToken', 'token', 'jwt', 'accessToken'];
  for(const key of tokenKeys){
    const val = localStorage.getItem(key) || sessionStorage.getItem(key);
    if(val) return val;
  }
  return '';
}
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>\"'`=\\/]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[ch]); }

// --- helpers for fields returned by Mongo-like outputs ---
function extractId(idField){
  // Accept string id, or object like {"$oid":"..."}
  if(!idField) return '';
  if(typeof idField === 'string') return idField;
  if(typeof idField === 'object'){
    if(idField.$oid) return idField.$oid;
    if(idField['$id']) return idField['$id'];
    // fallback ‚Äî try toString
    try { return String(idField); } catch(e){ return ''; }
  }
  return String(idField);
}

function parseDate(val){
  // Accept ISO string, Date object, or nested mongo $date / $numberLong shapes
  if(!val) return null;
  // if object with $date
  if(typeof val === 'object'){
    if(val.$date){
      // $date can be ISO string or { $numberLong: "..." }
      if(typeof val.$date === 'string') return new Date(val.$date);
      if(typeof val.$date === 'object' && val.$date.$numberLong) return new Date(parseInt(val.$date.$numberLong, 10));
    }
    if(val.$numberLong) return new Date(parseInt(val.$numberLong, 10));
    if(val['$numberLong']) return new Date(parseInt(val['$numberLong'], 10));
    // sometimes date stored as {"$date":{"$numberLong":"..."}}
    if(val['$date'] && val['$date']['$numberLong']) return new Date(parseInt(val['$date']['$numberLong'],10));
  }
  // if string
  if(typeof val === 'string' || typeof val === 'number'){
    const d = new Date(val);
    if(!isNaN(d.getTime())) return d;
  }
  return null;
}

// --- AUTH: check logged-in user and role (used to enable/disable UI) ---
let currentUser = null;
async function fetchCurrentUser(){
  try{
    const token = getToken();
    if(!token){
      console.warn('No token found, redirecting to login...');
      // Clear all possible token keys
      const tokenKeys = ['authToken', 'token', 'jwt', 'accessToken'];
      tokenKeys.forEach(k => {
        localStorage.removeItem(k);
        sessionStorage.removeItem(k);
      });
      // Redirect to login page
      window.location.href = '/login';
      return null;
    }
    const headers = { 'Authorization': 'Bearer '+token };
    const res = await fetch(`${API_BASE}/me`, { headers });
    if(!res.ok){
      if(res.status === 401){
        console.warn('Token invalid or expired, redirecting to login...');
        // Clear all possible token keys
        const tokenKeys = ['authToken', 'token', 'jwt', 'accessToken'];
        tokenKeys.forEach(k => {
          localStorage.removeItem(k);
          sessionStorage.removeItem(k);
        });
        // Redirect to login page
        window.location.href = '/login';
        return null;
      }
      return null;
    }
    const json = await res.json();
    currentUser = json.user || json || null;
    
    // Verify user is admin
    if(currentUser && currentUser.role !== 'admin'){
      console.warn('User is not an admin, redirecting...');
      window.location.href = '/login';
      return null;
    }
    
    // populate header
    if(currentUser){
      const name = currentUser.name || (currentUser.first_name ? (currentUser.first_name + ' ' + (currentUser.last_name||'')) : 'Admin');
      if($('adminShortName')) $('adminShortName').textContent = name.split(' ')[0];
      if($('adminFullName')) $('adminFullName').textContent = name;
      if($('adminRoleBadge')) $('adminRoleBadge').textContent = `Role: ${currentUser.role||'user'}`;
      if(currentUser.avatar_url && $('adminAvatar')) $('adminAvatar').src = currentUser.avatar_url;
    }
    return currentUser;
  }catch(err){
    console.warn('fetchCurrentUser', err);
    // On error, redirect to login
    window.location.href = '/login';
    return null;
  }
}

function isAdmin(){ return currentUser && currentUser.role === 'admin'; }
function isOfficer(){ return currentUser && currentUser.role === 'officer'; }
function isCitizen(){ return currentUser && currentUser.role === 'citizen'; }

// ---------------- USERS ----------------
let usersCache = [];
async function loadUsers({ role='', q='' } = {}){
  try{
    const params = new URLSearchParams();
    if(role) params.append('role', role);
    if(q) params.append('q', q);
    const token = getToken();
    if(!token){
      $('usersTbody').innerHTML = `<tr><td colspan="7" class="small-muted">Please log in to view users</td></tr>`;
      return;
    }
    const res = await fetch(`${API_BASE}/admin/users${params.toString() ? '?'+params.toString() : ''}`, { headers: {'Authorization':'Bearer '+token} });
    if(!res.ok){
      const txt = await res.text().catch(()=>res.statusText);
      if(res.status === 401){
        $('usersTbody').innerHTML = `<tr><td colspan="7" class="small-muted">Unauthorized. Please log in.</td></tr>`;
        return;
      }
      $('usersTbody').innerHTML = `<tr><td colspan="7" class="small-muted">Failed to load users: ${escapeHtml(txt)}</td></tr>`;
      return;
    }
    const json = await res.json();
    // backend might return array or { users: [...] }
    usersCache = Array.isArray(json) ? json : (json.users || json.data || json.result || []);
    renderUsers(usersCache);
    computeStats(usersCache);
  }catch(err){
    console.error(err);
    $('usersTbody').innerHTML = `<tr><td colspan="7" class="small-muted">Error loading users</td></tr>`;
  }
}

function renderUsers(list){
  const tbody = $('usersTbody');
  if(!Array.isArray(list) || list.length === 0){
    tbody.innerHTML = `<tr><td colspan="7" class="small-muted">No users found.</td></tr>`;
    return;
  }
  tbody.innerHTML = '';
  list.forEach((u, idx) => {
    const id = extractId(u._id || u.id || u.user_id);
    // name fallbacks: name, first_name + last_name, fname/lname
    const name = u.name || (u.first_name ? (u.first_name + ' ' + (u.last_name||'')) : (u.fname ? (u.fname + ' ' + (u.lname||'')) : 'User'));
    const email = u.email || u.email_address || '';
    const role = u.role || u.user_type || '';
    const badge = u.badge_number || u.badge || u.bad_no || '';
    const dept = u.department || u.dept || '';
    const lastLoginDate = parseDate(u.last_login || u.last_login_at || u.lastSeen || u.last_active);
    const lastLogin = lastLoginDate ? lastLoginDate.toLocaleString() : '‚Äî';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <div style="width:42px;height:42px;border-radius:8px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-weight:600">${String((u.first_name || u.name || 'U')[0] || 'U').toUpperCase()}</div>
          <div>
            <div style="font-weight:600">${escapeHtml(name)}</div>
            <div class="small-muted xs">${escapeHtml(String(id).slice(-8))}</div>
          </div>
        </div>
      </td>
      <td>${escapeHtml(email)}</td>
      <td>${escapeHtml(role)}</td>
      <td>${escapeHtml(badge || dept)}</td>
      <td>${escapeHtml(lastLogin)}</td>
      <td>
        <div class="actions">
          <button class="btn btn-sm" data-action="view" data-id="${escapeHtml(id)}">View</button>
          <button class="btn btn-sm btn-primary" data-action="edit" data-id="${escapeHtml(id)}">Edit</button>
          <button class="btn btn-sm danger" data-action="delete" data-id="${escapeHtml(id)}">Delete</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('button[data-action]').forEach(b => {
    const action = b.getAttribute('data-action'), id = b.getAttribute('data-id');
    b.addEventListener('click', () => {
      if(action === 'view') openViewUserModal(id);
      if(action === 'edit') openEditUserModal(id);
      if(action === 'delete') confirmDelete('user', id, 'Delete user?');
    });
  });
}

function computeStats(users=[]){
  $('statTotalUsers').textContent = users.length || 0;
  $('statActiveUsers').textContent = users.filter(u => {
    const d = parseDate(u.last_login || u.last_login_at || u.lastSeen);
    if(!d) return false;
    return (Date.now() - d.getTime()) <= (7*24*60*60*1000);
  }).length;
  $('statOfficers').textContent = users.filter(u => (u.role === 'officer' || u.user_type === 'officer')).length;
  $('statCitizens').textContent = users.filter(u => (u.role === 'citizen' || u.user_type === 'citizen')).length;
}

// user modals and CRUD ‚Äî using /api/admin/users endpoints (list provided)
function openAddUserModal(){
  if(!isAdmin()){ alert('Only admins can add users'); return; }
  if($('userModalTitle')) $('userModalTitle').textContent = 'Add New User';
  if($('userId')) $('userId').value = '';
  if($('firstName')) $('firstName').value = '';
  if($('lastName')) $('lastName').value = '';
  if($('email')) $('email').value = '';
  if($('role')) $('role').value = 'citizen';
  if($('badge')) $('badge').value = '';
  if($('department')) $('department').value = '';
  if($('password')) $('password').value = '';
  if($('userFormResult')) {
    $('userFormResult').textContent = '';
    $('userFormResult').className = 'text-sm font-medium';
  }
  showModal($('userModal'));
}

function openEditUserModal(id){
  const u = usersCache.find(x => extractId(x._id||x.id||x.user_id) === String(id));
  if(!u){ alert('User not found in cache'); return; }
  if($('userModalTitle')) $('userModalTitle').textContent = 'Edit User';
  if($('userId')) $('userId').value = extractId(u._id||u.id||u.user_id);
  if($('firstName')) $('firstName').value = u.first_name || u.fname || (u.name ? u.name.split(' ')[0] : '');
  if($('lastName')) $('lastName').value = u.last_name || u.lname || (u.name ? u.name.split(' ').slice(1).join(' ') : '');
  if($('email')) $('email').value = u.email || u.email_address || '';
  if($('role')) $('role').value = u.role || u.user_type || 'citizen';
  if($('badge')) $('badge').value = u.badge_number || u.badge || '';
  if($('department')) $('department').value = u.department || u.dept || '';
  if($('password')) $('password').value = '';
  if($('userFormResult')) {
    $('userFormResult').textContent = '';
    $('userFormResult').className = 'text-sm font-medium';
  }
  showModal($('userModal'));
}

async function openViewUserModal(id){
  try{
    const token = getToken();
    if(!token){
      alert('Please log in to view user details');
      return;
    }
    const res = await fetch(`${API_BASE}/admin/users/${encodeURIComponent(id)}`, { headers: {'Authorization':'Bearer '+token} });
    if(!res.ok){ 
      const error = await res.json().catch(() => ({error: 'Failed to fetch user details'}));
      alert(error.error || 'Failed to fetch user details'); 
      return; 
    }
    const u = await res.json();
    // some endpoints return object inside { user: {...} }
    const user = u.user || u;
    if($('userModalTitle')) $('userModalTitle').textContent = 'View User';
    if($('userId')) $('userId').value = extractId(user._id||user.id||user.user_id);
    if($('firstName')) $('firstName').value = user.first_name || user.fname || (user.name ? user.name.split(' ')[0] : '');
    if($('lastName')) $('lastName').value = user.last_name || user.lname || (user.name ? user.name.split(' ').slice(1).join(' ') : '');
    if($('email')) $('email').value = user.email || '';
    if($('role')) $('role').value = user.role || user.user_type || 'citizen';
    if($('badge')) $('badge').value = user.badge_number || user.badge || '';
    if($('department')) $('department').value = user.department || user.dept || '';
    if($('password')) $('password').value = '';
    // disable inputs for readonly
    ['firstName','lastName','email','role','badge','department','password','saveUserBtn'].forEach(elid=>{
      const el = $(elid); if(!el) return;
      if(elid === 'saveUserBtn') el.style.display = 'none'; else el.setAttribute('disabled','disabled');
    });
    if($('userFormResult')) {
      $('userFormResult').textContent = '';
      $('userFormResult').className = 'text-sm font-medium';
    }
    showModal($('userModal'));
  }catch(err){ console.error(err); alert('Error loading user'); }
}

function closeUserModalRestore(){
  hideModal($('userModal'));
  ['firstName','lastName','email','role','badge','department','password','saveUserBtn'].forEach(elid=>{
    const el = $(elid); if(!el) return;
    if(elid === 'saveUserBtn') el.style.display = ''; else el.removeAttribute('disabled');
  });
}

async function createUser(payload){
  return fetch(`${API_BASE}/admin/users`, { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+getToken()}, body: JSON.stringify(payload) });
}
async function updateUser(id, payload){
  return fetch(`${API_BASE}/admin/users/${encodeURIComponent(id)}`, { method:'PUT', headers:{'Content-Type':'application/json','Authorization':'Bearer '+getToken()}, body: JSON.stringify(payload) });
}
async function deleteUserApi(id){
  return fetch(`${API_BASE}/admin/users/${encodeURIComponent(id)}`, { method:'DELETE', headers:{'Authorization':'Bearer '+getToken()} });
}

$('userForm')?.addEventListener('submit', async function(ev){
  ev.preventDefault();
  if(!isAdmin()){ alert('Only admins can save users from this dashboard'); return; }
  const id = $('userId').value;
  const payload = {
    first_name: $('firstName').value.trim(),
    last_name: $('lastName').value.trim(),
    email: $('email').value.trim(),
    role: $('role').value,
    badge_number: $('badge').value.trim(),
    department: $('department').value.trim()
  };
  const password = $('password').value.trim();
  // Password is required for new users, optional for updates
  if(!id && !password){
    if($('userFormResult')) { 
      $('userFormResult').textContent = 'Password is required for new users'; 
      $('userFormResult').className = 'text-sm font-medium text-red-600';
    }
    return;
  }
  if(password) payload.password = password;
  if($('userFormResult')) {
    $('userFormResult').textContent = 'Saving...';
    $('userFormResult').className = 'text-sm font-medium text-primary-600';
  }
  try{
    let res;
    if(!id) res = await createUser(payload);
    else res = await updateUser(id, payload);
    if(!res.ok){
      const txt = await res.text().catch(()=>res.statusText);
      if($('userFormResult')) { 
        $('userFormResult').textContent = 'Error: '+txt; 
        $('userFormResult').className = 'text-sm font-medium text-red-600';
      }
      return;
    }
    if($('userFormResult')) { 
      $('userFormResult').textContent = 'Saved'; 
      $('userFormResult').className = 'text-sm font-medium text-green-600';
    }
    setTimeout(()=>{ closeUserModalRestore(); loadAndRenderUsers(); }, 700);
  }catch(err){
    console.error(err);
    if($('userFormResult')) { 
      $('userFormResult').textContent = 'Network error'; 
      $('userFormResult').className = 'text-sm font-medium text-red-600';
    }
  }
});

// ---------------- CASES ----------------
let casesCache = [];
async function loadCases(){
  try{
    const token = getToken();
    if(!token){
      $('casesTbody').innerHTML = `<tr><td colspan="7" class="small-muted">Please log in to view cases</td></tr>`;
      return;
    }
    const res = await fetch(`${API_BASE}/admin/cases`, { headers: {'Authorization':'Bearer '+token} });
    if(!res.ok){
      const txt = await res.text().catch(()=>res.statusText);
      if(res.status === 401){
        $('casesTbody').innerHTML = `<tr><td colspan="7" class="small-muted">Unauthorized. Please log in.</td></tr>`;
        return;
      }
      $('casesTbody').innerHTML = `<tr><td colspan="7" class="small-muted">Failed to load cases: ${escapeHtml(txt)}</td></tr>`;
      return;
    }
    const json = await res.json();
    // json may be array or { cases: [...] }
    casesCache = Array.isArray(json) ? json : (json.cases || json.data || []);
    renderCases(casesCache);
  }catch(err){
    console.error(err);
    $('casesTbody').innerHTML = `<tr><td colspan="7" class="small-muted">Error loading cases</td></tr>`;
  }
}

function renderCases(list){
  const tbody = $('casesTbody');
  if(!Array.isArray(list) || list.length === 0){
    tbody.innerHTML = `<tr><td colspan="7" class="small-muted">No cases found.</td></tr>`;
    return;
  }
  tbody.innerHTML = '';
  list.forEach((c, idx) => {
    const id = extractId(c._id || c.id);
    const title = c.title || c.case_title || '‚Äî';
    const type = c.category || c.type || '‚Äî';
    const status = c.status || '‚Äî';
    const assigned = c.assigned_officer || c.assigned || '‚Äî';
    const createdDate = parseDate(c.created_at || c.created || c.createdAt);
    const created = createdDate ? createdDate.toLocaleString() : '‚Äî';
    const citizen = c.citizen_name || c.owner_name || (c.citizen ? (c.citizen.name||'') : '');
    const priority = c.priority || 'Normal';
    tbody.innerHTML += `
      <tr>
        <td>${idx+1}</td>
        <td>${escapeHtml(title)}<div class="xs small-muted">${escapeHtml(citizen||'')}</div></td>
        <td>${escapeHtml(type)}</td>
        <td>${escapeHtml(status)} ${priority ? ('<span class="small-muted"> | '+escapeHtml(priority)+'</span>') : ''}</td>
        <td>${escapeHtml(assigned)}</td>
        <td>${escapeHtml(created)}</td>
        <td>
          <div class="actions">
            <button class="btn btn-sm" data-action="view" data-id="${escapeHtml(id)}">View</button>
            <button class="btn btn-sm btn-primary" data-action="edit" data-id="${escapeHtml(id)}">Edit</button>
            <button class="btn btn-sm danger" data-action="delete" data-id="${escapeHtml(id)}">Delete</button>
          </div>
        </td>
      </tr>
    `;
  });

  tbody.querySelectorAll('button[data-action]').forEach(b => {
    const action = b.getAttribute('data-action'), id = b.getAttribute('data-id');
    b.addEventListener('click', () => {
      if(action === 'view') openViewCaseModal(id);
      if(action === 'edit') openEditCaseModal(id);
      if(action === 'delete') confirmDelete('case', id, 'Delete case?');
    });
  });
}

function openAddCaseModal(){
  if(!isAdmin() && !isCitizen()){ alert('Only admins (or citizens from their dashboard) may create cases here'); return; }
  if($('caseModalTitle')) $('caseModalTitle').textContent = 'Add Case';
  if($('caseId')) $('caseId').value = '';
  if($('caseTitle')) $('caseTitle').value = '';
  if($('caseType')) $('caseType').value = '';
  if($('caseStatus')) $('caseStatus').value = 'Pending';
  if($('caseAssigned')) $('caseAssigned').value = '';
  if($('caseDescription')) $('caseDescription').value = '';
  if($('caseFormResult')) {
    $('caseFormResult').textContent = '';
    $('caseFormResult').className = 'text-sm font-medium';
  }
  showModal($('caseModal'));
}

function openEditCaseModal(id){
  const c = casesCache.find(x => extractId(x._id||x.id) === String(id));
  if(!c){ alert('Case not found'); return; }
  if($('caseModalTitle')) $('caseModalTitle').textContent = 'Edit Case';
  if($('caseId')) $('caseId').value = extractId(c._id||c.id);
  if($('caseTitle')) $('caseTitle').value = c.title || '';
  if($('caseType')) $('caseType').value = c.category || c.type || '';
  if($('caseStatus')) $('caseStatus').value = c.status || 'Pending';
  if($('caseAssigned')) $('caseAssigned').value = c.assigned_officer || c.assigned || '';
  if($('caseDescription')) $('caseDescription').value = c.description || c.details || '';
  if($('caseFormResult')) $('caseFormResult').textContent = '';
  showModal($('caseModal'));
}

async function openViewCaseModal(id){
  try{
    const token = getToken();
    const res = await fetch(`${API_BASE}/admin/cases/${encodeURIComponent(id)}`, { headers: token ? {'Authorization':'Bearer '+token} : {} });
    if(!res.ok){ alert('Failed to load case'); return; }
    const json = await res.json();
    const c = json.case || json;
    openEditCaseModal(c._id || c.id || id);
  }catch(err){
    console.error(err);
    alert('Error loading case');
  }
}

async function createCaseApi(payload){
  return fetch(`${API_BASE}/admin/cases`, { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+getToken()}, body: JSON.stringify(payload) });
}
async function updateCaseApi(id,payload){
  return fetch(`${API_BASE}/admin/cases/${encodeURIComponent(id)}`, { method:'PUT', headers:{'Content-Type':'application/json','Authorization':'Bearer '+getToken()}, body: JSON.stringify(payload) });
}
async function deleteCaseApi(id){
  return fetch(`${API_BASE}/admin/cases/${encodeURIComponent(id)}`, { method:'DELETE', headers:{'Authorization':'Bearer '+getToken()} });
}

$('caseForm')?.addEventListener('submit', async function(ev){
  ev.preventDefault();
  if(!isAdmin()){ alert('Only admins can create/edit cases from this dashboard'); return; }
  const id = $('caseId').value;
  const payload = {
    title: $('caseTitle').value.trim(),
    category: $('caseType').value.trim(),
    status: $('caseStatus').value,
    assigned_officer: $('caseAssigned').value.trim(),
    description: $('caseDescription').value.trim()
  };
  if($('caseFormResult')) {
    $('caseFormResult').textContent = 'Saving...';
    $('caseFormResult').className = 'text-sm font-medium text-primary-600';
  }
  try{
    let res;
    if(!id) res = await createCaseApi(payload);
    else res = await updateCaseApi(id,payload);
    if(!res.ok){
      const txt = await res.text().catch(()=>res.statusText);
      if($('caseFormResult')) { 
        $('caseFormResult').textContent = 'Error: '+txt; 
        $('caseFormResult').className = 'text-sm font-medium text-red-600';
      }
      return;
    }
    if($('caseFormResult')) { 
      $('caseFormResult').textContent = 'Saved'; 
      $('caseFormResult').className = 'text-sm font-medium text-green-600';
    }
    setTimeout(()=>{ hideModal($('caseModal')); loadAndRenderCases(); },700);
  }catch(err){
    console.error(err);
    if($('caseFormResult')) { 
      $('caseFormResult').textContent = 'Network error'; 
      $('caseFormResult').className = 'text-sm font-medium text-red-600';
    }
  }
});

// ---------------- FIRs ----------------
let firsCache = [];
async function loadFirs(){
  try{
    const token = getToken();
    if(!token){
      $('firsTbody').innerHTML = `<tr><td colspan="6" class="small-muted">Please log in to view FIRs</td></tr>`;
      return;
    }
    const res = await fetch(`${API_BASE}/admin/firs`, { headers: {'Authorization':'Bearer '+token} });
    if(!res.ok){
      const txt = await res.text().catch(()=>res.statusText);
      if(res.status === 401){
        $('firsTbody').innerHTML = `<tr><td colspan="6" class="small-muted">Unauthorized. Please log in.</td></tr>`;
        return;
      }
      $('firsTbody').innerHTML = `<tr><td colspan="6" class="small-muted">Failed to load FIRs: ${escapeHtml(txt)}</td></tr>`;
      return;
    }
    const json = await res.json();
    // Admin endpoint returns array directly
    firsCache = Array.isArray(json) ? json : (json.firs || json.data || []);
    renderFirs(firsCache);
  }catch(err){
    console.error(err);
    $('firsTbody').innerHTML = `<tr><td colspan="6" class="small-muted">Error loading FIRs</td></tr>`;
  }
}

function renderFirs(list){
  const tbody = $('firsTbody');
  if(!Array.isArray(list) || list.length === 0){
    tbody.innerHTML = `<tr><td colspan="6" class="small-muted">No FIRs found.</td></tr>`;
    return;
  }
  tbody.innerHTML = '';
  list.forEach((f, idx) => {
    const id = extractId(f._id || f.id);
    const title = f.title || '‚Äî';
    const officerName = f.officer_name || f.officer_id || '‚Äî';
    const complainant = f.complainant_name || '‚Äî';
    const status = f.status || '‚Äî';
    // created_at might be nested as in your sample: {"$date":{"$numberLong":"..."}}
    const createdDate = parseDate(f.created_at || f.created || f.updated_at || f.updatedAt);
    const created = createdDate ? createdDate.toLocaleString() : '‚Äî';
    tbody.innerHTML += `
      <tr>
        <td>${idx+1}</td>
        <td>${escapeHtml(title)}</td>
        <td>${escapeHtml(officerName)}</td>
        <td>${escapeHtml(status)}</td>
        <td>${escapeHtml(created)}</td>
        <td>
          <div class="actions">
            <button class="btn btn-sm" data-action="view" data-id="${escapeHtml(id)}">View</button>
            <button class="btn btn-sm btn-primary" data-action="edit" data-id="${escapeHtml(id)}">Edit</button>
            <button class="btn btn-sm danger" data-action="delete" data-id="${escapeHtml(id)}">Delete</button>
          </div>
        </td>
      </tr>
    `;
  });

  tbody.querySelectorAll('button[data-action]').forEach(b => {
    const action = b.getAttribute('data-action'), id = b.getAttribute('data-id');
    b.addEventListener('click', () => {
      if(action === 'view') openViewFir(id);
      if(action === 'edit') openEditFir(id);
      if(action === 'delete') confirmDelete('fir', id, 'Delete FIR?');
    });
  });
}

// Note: Admins cannot create FIRs - only officers can. Admins can only view and update existing FIRs.

function openEditFir(id){
  const f = firsCache.find(x => extractId(x._id||x.id) === String(id));
  if(!f){ alert('FIR not found'); return; }
  if($('firModalTitle')) $('firModalTitle').textContent = 'View/Edit FIR';
  if($('firId')) $('firId').value = extractId(f._id||f.id);
  if($('firTitle')) $('firTitle').value = f.title || '';
  if($('firOfficer')) $('firOfficer').value = f.officer_name || f.officer_id || '';
  if($('firStatus')) $('firStatus').value = f.status || 'Pending';
  if($('firDetails')) $('firDetails').value = f.officer_notes || f.description || f.details || '';
  if($('firFormResult')) {
    $('firFormResult').textContent = '';
    $('firFormResult').className = 'text-sm font-medium';
  }
  showModal($('firModal'));
}

async function openViewFir(id){
  try{
    const token = getToken();
    const res = await fetch(`${API_BASE}/admin/firs/${encodeURIComponent(id)}`, { headers: token ? {'Authorization':'Bearer '+token} : {} });
    if(!res.ok){ alert('Failed to fetch FIR'); return; }
    const json = await res.json();
    const f = json.fir || json;
    openEditFir(f._id || f.id || id);
  }catch(err){
    console.error(err); alert('Error loading FIR');
  }
}

async function createFirApi(payload){ 
  // Note: Admin can't create FIRs directly - they should be created by officers
  // This is a placeholder - you may want to remove this or route to officer endpoint
  return fetch(`${API_BASE}/officer/fir`, { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+getToken()}, body: JSON.stringify(payload) }); 
}
async function updateFirApi(id,payload){ return fetch(`${API_BASE}/admin/firs/${encodeURIComponent(id)}`, { method:'PUT', headers:{'Content-Type':'application/json','Authorization':'Bearer '+getToken()}, body: JSON.stringify(payload) }); }
async function deleteFirApi(id){ return fetch(`${API_BASE}/admin/firs/${encodeURIComponent(id)}`, { method:'DELETE', headers:{'Authorization':'Bearer '+getToken()} }); }

$('firForm')?.addEventListener('submit', async function(ev){
  ev.preventDefault();
  if(!isAdmin()){ alert('Only admins can update FIRs from this dashboard'); return; }
  const id = $('firId').value;
  if(!id){
    alert('FIR creation should be done by officers. Admins can only update existing FIRs.');
    return;
  }
  const payload = {
    status: $('firStatus').value,
    officer_notes: $('firDetails').value.trim()
  };
  if($('firFormResult')) {
    $('firFormResult').textContent = 'Saving...';
    $('firFormResult').className = 'text-sm font-medium text-primary-600';
  }
  try{
    const res = await updateFirApi(id, payload);
    if(!res.ok){
      const txt = await res.text().catch(()=>res.statusText);
      if($('firFormResult')) { 
        $('firFormResult').textContent = 'Error: '+txt; 
        $('firFormResult').className = 'text-sm font-medium text-red-600';
      }
      return;
    }
    if($('firFormResult')) { 
      $('firFormResult').textContent = 'Saved'; 
      $('firFormResult').className = 'text-sm font-medium text-green-600';
    }
    setTimeout(()=>{ hideModal($('firModal')); loadAndRenderFirs(); },700);
  }catch(err){
    console.error(err);
    if($('firFormResult')) { 
      $('firFormResult').textContent = 'Network error'; 
      $('firFormResult').className = 'text-sm font-medium text-red-600';
    }
  }
});

// ---------------- ALERTS ----------------
async function loadAlerts(){
  try{
    const token = getToken();
    if(!token){
      $('alertsList').innerHTML = `<div class="small-muted">Please log in to view alerts</div>`;
      return;
    }
    const res = await fetch(`${API_BASE}/admin/alerts`, { headers: {'Authorization':'Bearer '+token} });
    if(!res.ok){
      if(res.status === 401){
        $('alertsList').innerHTML = `<div class="small-muted">Unauthorized. Please log in.</div>`;
        return;
      }
      $('alertsList').innerHTML = `<div class="small-muted">No alerts or unauthorized</div>`;
      return;
    }
    const json = await res.json();
    const list = Array.isArray(json) ? json : (json.alerts || json.data || []);
    renderAlerts(list);
  }catch(err){
    console.error(err);
    $('alertsList').innerHTML = `<div class="small-muted">Error loading alerts</div>`;
  }
}

function renderAlerts(list){
  if(!Array.isArray(list) || list.length === 0){ $('alertsList').innerHTML = '<div class="small-muted">No alerts</div>'; return; }
  $('alertsList').innerHTML = list.map(a=>{
    const when = parseDate(a.sent_at || a.created_at || a.created);
    const sentBy = a.sent_by || 'System';
    return `<div style="border-bottom:1px solid var(--border);padding:8px 0"><div style="font-weight:600">${escapeHtml(a.title||'Alert')}</div><div class="small-muted xs">${when?when.toLocaleString():''} by ${escapeHtml(sentBy)}</div><div>${escapeHtml(a.message||'')}</div></div>`;
  }).join('');
}

async function sendAlert(payload){
  return fetch(`${API_BASE}/admin/alerts`, { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+getToken()}, body: JSON.stringify(payload) });
}

$('btnSendAlert')?.addEventListener('click', async ()=>{
  if(!isAdmin()){ alert('Only admins may send alerts from this dashboard'); return; }
  const title = prompt('Alert title:'); if(!title) return;
  const message = prompt('Alert message:'); if(!message) return;
  try{
    const res = await sendAlert({ title, message });
    if(!res.ok){ const txt = await res.text().catch(()=>res.statusText); alert('Send failed: '+txt); }
    else { alert('Alert sent'); loadAlerts(); }
  }catch(err){ console.error(err); alert('Network error'); }
});

// ---------------- GENERIC DELETE ----------------
let deleteContext = { type:null, id:null };
function confirmDelete(type, id, message){
  deleteContext = { type, id };
  if($('confirmDeleteMessage')) $('confirmDeleteMessage').textContent = message || 'Are you sure?';
  showModal($('confirmDeleteModal'));
}

$('confirmDeleteBtn')?.addEventListener('click', async ()=>{
  if(!deleteContext.type || !deleteContext.id) return;
  try{
    if(deleteContext.type === 'user'){
      if(!isAdmin()){ alert('Only admins may delete users'); return; }
      const res = await deleteUserApi(deleteContext.id);
      if(!res.ok){ const t = await res.text().catch(()=>res.statusText); alert('Delete failed: '+t); }
      else { alert('User deleted'); loadAndRenderUsers(); }
    }
    if(deleteContext.type === 'case'){
      if(!isAdmin()){ alert('Only admins may delete cases here'); return; }
      const res = await deleteCaseApi(deleteContext.id);
      if(!res.ok){ const t = await res.text().catch(()=>res.statusText); alert('Delete failed: '+t); }
      else { alert('Case deleted'); loadAndRenderCases(); }
    }
    if(deleteContext.type === 'fir'){
      if(!isAdmin()){ alert('Only admins may delete FIRs from this dashboard'); return; }
      const res = await deleteFirApi(deleteContext.id);
      if(!res.ok){ const t = await res.text().catch(()=>res.statusText); alert('Delete failed: '+t); }
      else { alert('FIR deleted'); loadAndRenderFirs(); }
    }
  }catch(err){
    console.error(err); alert('Network error during delete');
  }finally{
    deleteContext = { type:null, id:null };
    hideModal($('confirmDeleteModal'));
  }
});

$('cancelDeleteBtn')?.addEventListener('click', ()=>{ deleteContext = {type:null,id:null}; hideModal($('confirmDeleteModal')); });
$('closeConfirmDelete')?.addEventListener('click', ()=>{ deleteContext = {type:null,id:null}; hideModal($('confirmDeleteModal')); });

// ---------------- EXPORT CSV ----------------
$('bulkExportBtn')?.addEventListener('click', ()=>{ exportUsersCsv(usersCache); });
function exportUsersCsv(users){
  if(!Array.isArray(users) || users.length===0){ alert('No users to export'); return; }
  const rows = [];
  const headers = ['id','name','email','role','badge','department','last_login'];
  rows.push(headers.join(','));
  users.forEach(u=>{
    const id = extractId(u._id || u.id || u.user_id);
    const name = (u.name || (u.first_name ? (u.first_name + ' ' + (u.last_name||'')) : '')).replace(/,/g,' ');
    const email = u.email || '';
    const role = u.role || '';
    const badge = u.badge_number || u.badge || '';
    const dept = u.department || u.dept || '';
    const last = (parseDate(u.last_login || u.last_login_at) || '').toString();
    rows.push([id, name, email, role, badge, dept, last].map(v => `"${String(v||'').replace(/"/g,'""')}"`).join(','));
  });
  const csv = rows.join('\n');
  const blob = new Blob([csv], { type:'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'users_export.csv'; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
}

// ---------------- LOAD & WIRING ----------------
async function loadAndRenderUsers(){ const role = $('filterRole')?.value || ''; const q = $('filterQuery')?.value?.trim() || ''; await loadUsers({ role, q }); }
async function loadAndRenderCases(){ await loadCases(); }
async function loadAndRenderFirs(){ await loadFirs(); }
async function loadAll(){ await fetchCurrentUser(); await loadAndRenderUsers(); await loadAndRenderCases(); await loadAndRenderFirs(); await loadAlerts(); }

// UI wiring
$('btnAddUser')?.addEventListener('click', openAddUserModal);
$('cancelUserBtn')?.addEventListener('click', closeUserModalRestore);
$('closeUserModal')?.addEventListener('click', closeUserModalRestore);
$('btnReload')?.addEventListener('click', loadAndRenderUsers);
$('applyFilters')?.addEventListener('click', loadAndRenderUsers);
$('filterQuery')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') loadAndRenderUsers(); });
$('globalSearch')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ $('filterQuery').value = e.target.value.trim(); $('filterRole').value=''; loadAndRenderUsers(); }});

$('btnAddCase')?.addEventListener('click', openAddCaseModal);
$('cancelCaseBtn')?.addEventListener('click', ()=>hideModal($('caseModal')));
$('closeCaseModal')?.addEventListener('click', ()=>hideModal($('caseModal')));
$('btnReloadCases')?.addEventListener('click', loadAndRenderCases);

$('btnReloadFirs')?.addEventListener('click', loadAndRenderFirs);
$('cancelFirBtn')?.addEventListener('click', ()=>hideModal($('firModal')));
$('closeFirModal')?.addEventListener('click', ()=>hideModal($('firModal')));

$('btnSendAlert')?.addEventListener('click', async ()=>{ 
  if(!isAdmin()){ alert('Only admins may send alerts from this dashboard'); return; }
  const title = prompt('Alert title:'); if(!title) return;
  const message = prompt('Alert message:'); if(!message) return;
  try{ const res = await sendAlert({ title, message }); if(!res.ok){ const t = await res.text().catch(()=>res.statusText); alert('Send failed: '+t); } else { alert('Alert sent'); loadAlerts(); } }catch(err){ console.error(err); alert('Network error'); }
});

// user menu toggle
const userBtn = $('openUserMenuBtn'), userDropdown = $('userDropdown');
if(userBtn){
  userBtn.addEventListener('click', (e)=>{ e.stopPropagation(); userDropdown.style.display = userDropdown.style.display === 'block' ? 'none' : 'block'; });
  document.addEventListener('click', (e)=>{ if(!userDropdown.contains(e.target) && !userBtn.contains(e.target)) userDropdown.style.display = 'none'; });
}

// ---------------- MODAL HANDLERS ----------------
// ESC key to close modals
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    const openModals = document.querySelectorAll('.modal-backdrop.open');
    if (openModals.length > 0) {
      openModals.forEach(modal => {
        const modalId = modal.id;
        if (modalId === 'userModal') hideModal($('userModal'));
        else if (modalId === 'caseModal') hideModal($('caseModal'));
        else if (modalId === 'firModal') hideModal($('firModal'));
        else if (modalId === 'confirmDeleteModal') hideModal($('confirmDeleteModal'));
      });
    }
  }
});

// Backdrop click to close modals
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal-backdrop')) {
    const modalId = e.target.id;
    if (modalId === 'userModal') hideModal($('userModal'));
    else if (modalId === 'caseModal') hideModal($('caseModal'));
    else if (modalId === 'firModal') hideModal($('firModal'));
    else if (modalId === 'confirmDeleteModal') hideModal($('confirmDeleteModal'));
  }
});

// Prevent modal content clicks from closing modal
document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('click', (e) => {
    e.stopPropagation();
  });
});

// Ensure all modals are hidden on page load
document.addEventListener('DOMContentLoaded', () => {
  ['userModal', 'caseModal', 'firModal', 'confirmDeleteModal'].forEach(id => {
    const modal = $(id);
    if (modal) {
      modal.style.display = 'none';
      modal.classList.remove('open');
    }
  });
});

// Init
(async function init(){
  // First, fetch current user and verify admin role
  const user = await fetchCurrentUser();
  if(!user || user.role !== 'admin'){
    // fetchCurrentUser already redirects, but just in case
    console.warn('Not authorized as admin');
    return;
  }
  // Only load data if user is authenticated as admin
  try{ 
    await loadAll(); 
  }catch(e){ 
    console.warn('initial load error',e); 
  }
})();
</script>

</body>
</html>
